<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>WITNESS ME</title>
    <script src="https://unpkg.com/mithril/mithril.js"></script>
</head>

<body>
</body>

<!-- Trucs API Google login -->
<script>
    //Si ça bug trop, utiliser la version simplifiée : https://developers.google.com/identity/gsi/web/guides/get-google-api-clientid?hl=en
    //TODO : figure out how to do a google sign-in just to get the name or email address
    //AKA just for sign-in
    function handleClientLoad() {
        // Load the API client and auth2 library
        gapi.load('client:auth2', initClient);
    }


    function initClient() {
        var GoogleAuth //Google Auth object.
        console.log("1")
        console.log(GoogleAuth)
        gapi.client.init({
            'apiKey': 'AIzaSyDKHegSyxOiV8N-7RyKUfBL5Ks_cgoJEZA',
            'clientId': '852760108989-gqn73cl4kuk3nb5a8mgf38rgace4u3lk.apps.googleusercontent.com',
            'scope': 'openid'
        }).then(function () {
            GoogleAuth = gapi.auth2.getAuthInstance();
            console.log("2")
            console.log(GoogleAuth)
            //Listen for sign-in stage changes.
            GoogleAuth.isSignedIn.listen(updateSigninStatus);
        })
    }

    var isAuthorized;
    var currentApiRequest;

    /**
     * Store the request details. Then check to determine whether the user
     * has authorized the application.
     *   - If the user has granted access, make the API request.
     *   - If the user has not granted access, initiate the sign-in flow.
     */
    function sendAuthorizedApiRequest(requestDetails) {
        currentApiRequest = requestDetails;
        if (isAuthorized) {
            // Make API request
            // gapi.client.request(requestDetails)

            // Reset currentApiRequest variable.
            currentApiRequest = {};
        } else {
            GoogleAuth.signIn();
        }
    }

    /**
     * Listener called when user completes auth flow. If the currentApiRequest
     * variable is set, then the user was prompted to authorize the application
     * before the request executed. In that case, proceed with that API request.
     */
    function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
            isAuthorized = true;
            if (currentApiRequest) {
                sendAuthorizedApiRequest(currentApiRequest);
            }
        } else {
            isAuthorized = false;
        }
    }
</script>


<!-- Routage-->
<script>
    var Splash = {
        view: function () {
            return m("main", [
                m("h1", {
                    class: "title"
                }, "Tinygram"),
                m("div", [
                    m("a", {
                        href: "#!/AddUser"
                    }, "Ajouter un utilisateur"),
                    m("a", {
                        href: "#!/MockLogin"
                    }, "Tentative de connexion Google"),
                    m("a", {
                            href: "#!/MockProfile"
                        },
                        "Affichage infos Google (TODO : mettre ça autre part genre une notification 'vous etes connectés'"
                        )
                ])
            ])
        }
    }
    // Probleme, require n'est pas possible sur du js client... On réflichira plus tard sur comment implémenter des vues.
    //var AddUser = require("./views/AddUser")

    var AddUser = {
        view: function () {
            return m("main", [
                m("h1", {
                    class: "title"
                }, "Tinygram"),
                m("form", {
                    id: "inscription",
                    onsubmit: e => {
                        e.preventDefault()
                        m.request({
                            method: 'POST',
                            url: '/addPpl',
                            params: {
                                id: document.getElementById('id').value
                            }
                        }).then(data => {
                            m.render(document.getElementById("reponse"),
                                `Vous êtes enregistré avec l’adresse ${data}`)
                        })
                    }
                }, [
                    m("h2", {
                        class: "formtitle"
                    }, "S'inscrire"),
                    m("label", {
                        for: "id"
                    }, "Adresse"),
                    m("input", {
                        id: "id",
                        type: "text",
                        name: "id",
                        value: ""
                    }),
                    m("input", {
                        type: "submit",
                        name: "C'est parti",
                    })
                ]),
                m("div", {
                    id: "reponse"
                }, "Pas encore de reponse...")
            ])
        }
    }


    //TODO: faire 2 boutons connex/deconnex
    var MockLogin = {
        view: function () {
            return m("main", [
                    m("p", {
                        class: "title"
                    }, "Ouah deux boutons")
                ]),
                m("div", {
                    id: "content"
                }, "what the fuck")
        }
    }


    var MockProfile = {
        //TODO :call some random API using GoogleAuth

    }

    m.route(document.body, "/splash", {
        "/splash": Splash,
        "/AddUser": AddUser,
        "/MockLogin": MockLogin
    })
</script>

<script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>

<!---
Checklist :
- Nouveau projet dans GCP -- V
- Utiliser datastore pour insérer/query -- ~
- Routage/backend pour naviguer l'UI (voir tuto mithril js) -- ~
- Produire des services API test (voir docs java v11 https://cloud.google.com/appengine/docs/standard/java11) -- X
- Tester avec produit fourni ds cloud platform et/ou postman -- X
- Pour java : voir ce qu'a fait le prof dans WebAndCloud
- Pour front-end : : https://developers.google.com/identity/protocols/oauth2/javascript-implicit-flow?hl=en
- Mettre en place google login (v2) (accés api backend java ET pour front end) -- X
- Produire les services API correspondant aux tâches listés dans le projet
(profil de quelqu'un, bouton follow, liste de posts, post un post, like un post) -- X
- Faire un feed d'actualité -- X 
- Faire le frontend -- X
!-->

</html>