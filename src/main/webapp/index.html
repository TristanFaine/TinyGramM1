<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
    <title>Le TinyGram du futur</title>
    <script src="https://unpkg.com/mithril/mithril.js"></script>
</head>

<body>
    <div class="topnav">
        <a class="active" href="#Splash">Menu Principal</a>
        <button id="sign-in-or-out-button">Sign In/Authorize</button>
        <button id="revoke-access-button" style="display: none">Revoke Access</button>
    </div>
    <hr>
    <div id="auth-status" style="display: inline; padding-left: 25px"></div><hr>

    <main id="app"></main>
</body>

<!-- Trucs API Google login -->
<script>
    //Si ça bug trop, utiliser la version simplifiée : https://developers.google.com/identity/gsi/web/guides/get-google-api-clientid?hl=en
    //Vu qu'on compte juste utiliser googleUser.getAuthResponse().id_token;


    //https://developers.google.com/identity/sign-in/web/backend-auth?hl=en
    //Voir ceci pour l'auth en back^

    //AKA just for sign-in
    var GoogleAuth //Google Auth object.
    var SCOPE = 'openid';


    function handleClientLoad() {
        // Load the API client and auth2 library
        gapi.load('client:auth2', initClient);
    }
    function initClient() {
        
        gapi.client.init({
            'apiKey': 'AIzaSyDKHegSyxOiV8N-7RyKUfBL5Ks_cgoJEZA',
            'clientId': '852760108989-gqn73cl4kuk3nb5a8mgf38rgace4u3lk.apps.googleusercontent.com',
            'scope': SCOPE
        }).then(function () {
            GoogleAuth = gapi.auth2.getAuthInstance();
            console.log("DEBUG: you see this if properly connected to client credential")
            console.log(GoogleAuth)
            //Listen for sign-in stage changes.
            GoogleAuth.isSignedIn.listen(updateSigninStatus);

            //Handle initial sign-in state
            var user = GoogleAuth.currentUser.get();
            setSigninStatus();

            document.getElementById("sign-in-or-out-button").addEventListener('click',function() {
                handleAuthClick();
            }, false);
            document.getElementById("revoke-access-button").addEventListener('click', function() {
                revokeAccess();
            }, false);
        })
    }

    function handleAuthClick() {
        
        if (GoogleAuth.isSignedIn.get()) {
            GoogleAuth.signOut();
            //TODO: change page layout/route based on current location?
            // Example : on the "profileDisplay" page, reload layout
            // AKA : m.route.set("/MockProfile", {auth: false})
            // Could cause problem if we do something like :
            //this "post picture" button will log you in if not logged in,
            // THEN post the picture
            // and having two different functions do the same thing would be confusing..
        } else {
            GoogleAuth.signIn();
        }
    }
    function revokeAccess() {
        GoogleAuth.disconnect();
    }


    var isAuthorized;
    var currentApiRequest;
    /**
     * Store the request details. Then check to determine whether the user
     * has authorized the application.
     *   - If the user has granted access, make the API request.
     *   - If the user has not granted access, initiate the sign-in flow.
     */
    function sendAuthorizedApiRequest(requestDetails) {
        currentApiRequest = requestDetails;
        if (isAuthorized) {
            // Make API request
            // gapi.client.request(requestDetails)...
            // ou un truc XHR

            // Reset currentApiRequest variable.
            currentApiRequest = {};
        } else {
            GoogleAuth.signIn();
        }
    }

    /**
     * Listener called when user completes auth flow. If the currentApiRequest
     * variable is set, then the user was prompted to authorize the application
     * before the request executed. In that case, proceed with that API request.
     */
    //AKA : this is called after GoogleAuth.signIn, no matter what.
    function updateSigninStatus(isSignedIn) {
        setSigninStatus();
    }

    function setSigninStatus() {
        var user = GoogleAuth.currentUser.get();
        var isAuthorized = user.hasGrantedScopes(SCOPE);
        if (isAuthorized) {
            document.getElementById("sign-in-or-out-button").innerHTML = ("Sign out");
            document.getElementById("revoke-access-button").style.display = "inline-block";
            document.getElementById("auth-status").innerHTML = ("Connecté + accés autorisé");
        } else {
            document.getElementById("sign-in-or-out-button").innerHTML = ("Sign In/Authorize");
            document.getElementById("revoke-access-button").style.display = "none"; 
            document.getElementById("auth-status").innerHTML = ("Déconnecté, ou accés non autorisé");
        }
    }

</script>

<script type="module" src="routing.js"></script>

<script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()"
    onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>

<!---
Checklist :
- Nouveau projet dans GCP -- V
- Utiliser datastore pour insérer/query -- ~
- Routage/backend pour naviguer l'UI (voir tuto mithril js) -- ~
- Produire des services API test (voir docs java v11 https://cloud.google.com/appengine/docs/standard/java11) -- X
- Tester avec produit fourni ds cloud platform et/ou postman -- X
- Pour java : voir ce qu'a fait le prof dans WebAndCloud
- Pour front-end : : https://developers.google.com/identity/protocols/oauth2/javascript-implicit-flow?hl=en
- Mettre en place google login (v2) (accés api backend java ET pour front end) -- X
- Produire les services API correspondant aux tâches listés dans le projet
(profil de quelqu'un, bouton follow, liste de posts, post un post, like un post) -- X
- Faire un feed d'actualité -- X 
- Faire le frontend -- X
!-->


<!--
TODO:
Pour le routing/front/OAuth, voir si les trucs du genre User.getBasicProfile().getName() fonctionnent.
Faire un fichier controlleur.js

-->




</html>