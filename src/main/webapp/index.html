<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Le TinyGram du futur</title>
    <script src="https://unpkg.com/mithril/mithril.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <nav class="topnav">
        <a class="active" href="#Splash">Menu Principal</a>
        <button id="sign-in-or-out-button">Connexion/Autorisation</button>
        <button id="revoke-access-button" style="display: none">Révoquer Accès </button>
        <button id="image-post-access-button" style="display: none">Poster une image</button>
        <button id="profile-access-button" class="" style="display: none">Voir profil</button>
    </nav>
    <div id="auth-status"></div>
    <main id="app"></main>
</body>

<!-- Trucs API Google login -->
<script>
    var GoogleAuth
    //TODO : En read only pour l'instant, changer si on se sert de cloud storage
    var SCOPE =
        'openid https://www.googleapis.com/auth/cloud-platform.read-only https://www.googleapis.com/auth/devstorage.read_only';

    function handleClientLoad() {
        // Load the API client and auth2 library
        gapi.load('client:auth2', initClient);
    }

    function initClient() {
        gapi.client.init({
            //mettre ça dans le git est une mauvaise idée, les mettre dans un fichier ignoré via gitignore

            'apiKey': 'AIzaSyDKHegSyxOiV8N-7RyKUfBL5Ks_cgoJEZA',
            'clientId': '852760108989-gqn73cl4kuk3nb5a8mgf38rgace4u3lk.apps.googleusercontent.com',
            'scope': SCOPE
        }).then(function () {
            GoogleAuth = gapi.auth2.getAuthInstance();
            console.log("DEBUG: connected to client credential")
            //Écoute les changement de connexion
            GoogleAuth.isSignedIn.listen(updateSigninStatus);

            //S'occupe de l'état de connexion quand on entre dans l'application
            setSigninStatus();

            document.getElementById("sign-in-or-out-button").addEventListener('click', handleAuthClick, false);
            document.getElementById("revoke-access-button").addEventListener('click', revokeAccess, false);
            document.getElementById("profile-access-button").addEventListener('click', showProfile, false);
            document.getElementById("image-post-access-button").addEventListener('click', showSendImage, false);
        })
    }

    function handleAuthClick() {
        if (GoogleAuth.isSignedIn.get()) {
            GoogleAuth.signOut();
        } else {
            GoogleAuth.signIn().then((user) => {
                m.request({
                    method: 'POST',
                    url: '/_ah/api/api/v1/addUser',
                    params: {
                        id: user.getId()
                    }
                }).then(x => console.log(x))
            });
        }
    }

    function revokeAccess() {
        GoogleAuth.disconnect();
    }

    //TODO: define these "X" route names as vars so i don't have to retype them
    //perfectly every time.
    //TODO: définir ces noms de route "/X" dans un fichier config pour qu'on ait pas besoin
    //de les réécrire parfaitement à chaque fois dans les fichiers divers
    function routeSelect(route) {
        switch (route) {
            case "/splash":
                showHome();
                break;
            case "/AddUser":
                showUserInsertion();
                break;
            case '/Profile':
                showProfile();
                break;
            case '/SendImage':
                showSendImage();
                break;
            default:
                showHome();
                break;
        }
    }

    function showHome() {
        m.route.set("/Splash")
    }

    function showUserInsertion() {
        m.route.set("/AddUser")
    }

    function showProfile() {
        //TODO :faire un appel API ici, et renvoyer juste ce qui est nécessaire dans un Array je suppose
        //CECI N'INCLUS DONC PAS LE TOKEN!!!!! car ça passe par l'URL

        //Note: vu que les composants sont init avant la création de l'objet GoogleAuth,
        //Il faut être sûr que à l'initialisation, même aprés condition auth / pas auth
        //qu'il y ait pas d'accés direct à un objet défini ici.
        if (GoogleAuth.currentUser.get().hasGrantedScopes(SCOPE)) {
            var a = GoogleAuth.currentUser.get().getBasicProfile().getName();
            var b = GoogleAuth.currentUser.get().getBasicProfile().getImageUrl();
            var c = GoogleAuth.currentUser.get().getAuthResponse().id_token;
            var d = GoogleAuth.currentUser.get().hasGrantedScopes(SCOPE);
        }
        m.route.set("/Profile", {
            userName: a,
            userImage: b,
            userToken: c,
            authStatus: d
        })
    }

    function showSendImage() {
        if (GoogleAuth.currentUser.get().hasGrantedScopes(SCOPE)) {
            var d = GoogleAuth.currentUser.get().hasGrantedScopes(SCOPE);
        }
        m.route.set("/SendImage", {
            authStatus: d
        })
    }

    var isAuthorized; //unused for now, this doesn't even have a value on init
    var currentApiRequest; //unused for now
    /**
     * Store the request details. Then check to determine whether the user
     * has authorized the application.
     *   - If the user has granted access, make the API request.
     *   - If the user has not granted access, initiate the sign-in flow.
     */
    function sendAuthorizedApiRequest(requestDetails) {
        currentApiRequest = requestDetails;
        if (isAuthorized) {
            // Make API request
            // var gxhrgapi.client.request(requestDetails)...
            // gxhr.then(onFulfilled, onRejected, context)...
            // ou un truc XHR ou m.request

            // Reset currentApiRequest variable.
            currentApiRequest = {};
        } else {
            GoogleAuth.signIn()
        }
    }

    /**
     * Listener called when user completes auth flow. If the currentApiRequest
     * variable is set, then the user was prompted to authorize the application
     * before the request executed. In that case, proceed with that API request.
     */
    //AKA : this is called after GoogleAuth.signIn, no matter what.
    //Note: don't bother doing a GoogleAuth.signIn.then()... The timing of the resolved Promise is incorrect
    function updateSigninStatus(isSignedIn) {
        setSigninStatus();
    }

    function setSigninStatus() {
        var user = GoogleAuth.currentUser.get();
        var isAuthorized = user.hasGrantedScopes(SCOPE);
        if (isAuthorized) {
            document.getElementById("sign-in-or-out-button").innerHTML = ("Déconnexion");
            document.getElementById("revoke-access-button").style.display = "inline-block";
            document.getElementById("profile-access-button").style.display = "inline-block";
            document.getElementById("image-post-access-button").style.display = "inline-block";
            document.getElementById("auth-status").innerHTML = ("Connecté + permissions accordées");
        } else {
            document.getElementById("sign-in-or-out-button").innerHTML = ("Sign In/Authorize");
            document.getElementById("revoke-access-button").style.display = "none";
            document.getElementById("profile-access-button").style.display = "none";
            document.getElementById("image-post-access-button").style.display = "none";
            document.getElementById("auth-status").innerHTML = ("Déconnecté, ou permissions non accordées");
        }
        //Quick and dirty routing on signin status change, but it works
        routeSelect(m.route.get().split('?')[0]);
    }
</script>

<script type="module" src="controller/routing.js"></script>

<script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>

<!---
Checklist :
- Nouveau projet dans GCP -- V
- Utiliser datastore pour insérer/query -- ~
- Routage/backend pour naviguer l'UI (voir tuto mithril js) -- ~
- Produire des services API test (voir docs java v11 https://cloud.google.com/appengine/docs/standard/java11) -- ~
- Tester avec produit fourni ds cloud platform et/ou postman -- X
- Mettre en place google login (v2) (accés api backend java ET pour front end) -- ~ front ok, back ok(?)
- Produire les services API correspondant aux tâches listés dans le projet
(profil de quelqu'un, bouton follow, faire un post, liste de nouveaux posts, post un post, like un post) -- X
- Faire un feed d'actualité -- X 
- Faire le frontend -- ~
- Faire fichier config caché pour stocker noms url genre "/addUser", et un autre caché pour stocker nos "secrets"
!-->

<!--
TODO FRONT:
Afficher liste users datastore, idem liste posts images

//https://cloud.google.com/appengine/docs/standard/java11/using-cloud-storage
//Je viens de remarquer un truc, notre backend utilise java 8 ou 11..?
//Apparament c'est le 8?
-->

</html>