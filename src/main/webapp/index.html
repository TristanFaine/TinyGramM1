<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
    <title>Le TinyGram du futur</title>
    <script src="https://unpkg.com/mithril/mithril.js"></script>
</head>

<!-- TODO: rendre cette barre beaucoup plus jolie
     Je verrais bien un bouton "VIEW PROFILE" en haut à droite-->
<body>
    <div class="topnav">
        <a class="active" href="#Splash">Menu Principal</a>
        <button id="sign-in-or-out-button">Sign In/Authorize</button>
        <button id="revoke-access-button" style="display: none">Revoke Access</button>
        <button id="profile-access-button" style="display: none">View profile</button>
    </div>
    <hr>
    <div id="auth-status" style="display: inline; padding-left: 25px"></div><hr>

    <main id="app"></main>
</body>

<!-- Trucs API Google login -->
<script>
    //Si ça bug trop, utiliser la version simplifiée : https://developers.google.com/identity/gsi/web/guides/get-google-api-clientid?hl=en
    //Vu qu'on compte juste utiliser googleUser.getAuthResponse().id_token;
    //https://developers.google.com/identity/sign-in/web/backend-auth?hl=en
    //Voir ceci pour l'auth en back java^

    var GoogleAuth //Google Auth object.

    //TODO: find a way to not get the "basic" info, aka name, email, etc, we don't really care about these, we just want a login solution
    var SCOPE = 'openid';


    function handleClientLoad() {
        // Load the API client and auth2 library
        gapi.load('client:auth2', initClient);
    }

    function initClient() { 
        gapi.client.init({
            'apiKey': 'AIzaSyDKHegSyxOiV8N-7RyKUfBL5Ks_cgoJEZA',
            'clientId': '852760108989-gqn73cl4kuk3nb5a8mgf38rgace4u3lk.apps.googleusercontent.com',
            'scope': SCOPE
        }).then(function () {
            GoogleAuth = gapi.auth2.getAuthInstance();
            console.log("DEBUG: connected to client credential")
            //Listen for sign-in stage changes.
            GoogleAuth.isSignedIn.listen(updateSigninStatus);

            //Handle initial sign-in state
            setSigninStatus();

            document.getElementById("sign-in-or-out-button").addEventListener('click',function() {
                handleAuthClick();
            }, false);
            document.getElementById("revoke-access-button").addEventListener('click', function() {
                revokeAccess();
            }, false);
            document.getElementById("profile-access-button").addEventListener('click', function() {
                showProfile();
            }, false);
        })
    }

    function handleAuthClick() {
        if (GoogleAuth.isSignedIn.get()) {
            GoogleAuth.signOut();
        } else {
            GoogleAuth.signIn();
        }
    }

    function revokeAccess() {
        GoogleAuth.disconnect();
    }

    function routeSelect(route) {
        switch(route) {
            case '/splash':
                showHome();
                break;
            case '/Profile':
                showProfile();
                break;
            default:
                showHome();
                break;
        }
    }

    function showHome() {
        m.route.set("/Splash")
    }

    function showProfile() {
        //TODO :faire un appel API ici, et renvoyer juste ce qui est nécessaire dans un Array je suppose
        //CECI N'INCLUS DONC PAS LE TOKEN!!!!!
        if (GoogleAuth.currentUser.get().hasGrantedScopes(SCOPE)) {
            var a = GoogleAuth.currentUser.get().getBasicProfile().getName();
            var b = GoogleAuth.currentUser.get().getBasicProfile().getImageUrl();
            var c = GoogleAuth.currentUser.get().getAuthResponse().id_token;
            var d = GoogleAuth.currentUser.get().hasGrantedScopes(SCOPE);
        }
        m.route.set("/Profile", {userName: a, userImage: b, userToken: c, authStatus: d})
    }

    var isAuthorized; //unused for now, this doesn't even have a value on init
    var currentApiRequest; //unused for now
    /**
     * Store the request details. Then check to determine whether the user
     * has authorized the application.
     *   - If the user has granted access, make the API request.
     *   - If the user has not granted access, initiate the sign-in flow.
     */
    function sendAuthorizedApiRequest(requestDetails) {
        currentApiRequest = requestDetails;
        if (isAuthorized) {
            // Make API request
            // gapi.client.request(requestDetails)...
            // ou un truc XHR/API

            // Reset currentApiRequest variable.
            currentApiRequest = {};
        } else {
            GoogleAuth.signIn();
        }
    }

    /**
     * Listener called when user completes auth flow. If the currentApiRequest
     * variable is set, then the user was prompted to authorize the application
     * before the request executed. In that case, proceed with that API request.
     */
    //AKA : this is called after GoogleAuth.signIn, no matter what.
    //Note: don't bother doing a GoogleAuth.signIn.then()... The timing of the resolved Promise is incorrect
    function updateSigninStatus(isSignedIn) {
        setSigninStatus();
    }

    function setSigninStatus() {
        var user = GoogleAuth.currentUser.get();
        var isAuthorized = user.hasGrantedScopes(SCOPE);
        if (isAuthorized) {
            document.getElementById("sign-in-or-out-button").innerHTML = ("Sign out");
            document.getElementById("revoke-access-button").style.display = "inline-block";
            document.getElementById("profile-access-button").style.display = "inline-block";
            document.getElementById("auth-status").innerHTML = ("Connecté + permissions accordées");
        } else {
            document.getElementById("sign-in-or-out-button").innerHTML = ("Sign In/Authorize");
            document.getElementById("revoke-access-button").style.display = "none";
            document.getElementById("profile-access-button").style.display = "none";
            document.getElementById("auth-status").innerHTML = ("Déconnecté, ou permissions non accordées");
        }
        //Quick and dirty routing on signin status change, but it works
        routeSelect(m.route.get().split('?')[0]);
    }

</script>

<script type="module" src="controller/routing.js"></script>

<script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()"
    onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>

<!---
Checklist :
- Nouveau projet dans GCP -- V
- Utiliser datastore pour insérer/query -- ~
- Routage/backend pour naviguer l'UI (voir tuto mithril js) -- ~
- Produire des services API test (voir docs java v11 https://cloud.google.com/appengine/docs/standard/java11) -- X
- Tester avec produit fourni ds cloud platform et/ou postman -- X
- Pour java : voir ce qu'a fait le prof dans WebAndCloud
- Pour front-end : : https://developers.google.com/identity/protocols/oauth2/javascript-implicit-flow?hl=en
- Mettre en place google login (v2) (accés api backend java ET pour front end) -- X
- Produire les services API correspondant aux tâches listés dans le projet
(profil de quelqu'un, bouton follow, liste de posts, post un post, like un post) -- X
- Faire un feed d'actualité -- X 
- Faire le frontend -- X
!-->


<!--
TODO FRONT:
Afficher liste users datastore
idem pour liste posts images
Faut donc aller faire du back d'abord

-->




</html>